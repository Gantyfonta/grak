<!DOCTYPE html>
<html>
<head>
  <title>Chat with Grak the Caveman</title>
  <style>
    body { font-family: sans-serif; background: #f4f1e9; }
    #chat { width: 500px; margin: 20px auto; border: 2px solid #654321; padding: 10px; background: #fff8dc; border-radius: 10px; height: 400px; overflow-y: auto; }
    .msg { margin: 8px 0; }
    .user { color: darkblue; }
    .grak { color: darkgreen; font-weight: bold; }
    #input { width: 400px; padding: 5px; }
    button { padding: 5px 10px; }
    #loading { text-align: center; color: #a0522d; margin-top: 10px; }
  </style>
</head>
<body>
  <h1 style="text-align:center;">ðŸ’¬ Talk to Grak</h1>
  <div id="chat"><div id="loading">Loading Grak AIâ€¦ please wait</div></div>
  <div style="text-align:center; margin-top:10px;">
    <input id="input" placeholder="Say something..." disabled />
    <button id="sendBtn" disabled>Send</button>
  </div>

  <script type="module">
    import { pipeline } from "https://cdn.jsdelivr.net/npm/@xenova/transformers";

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const loading = document.getElementById("loading");

    async function initGrak() {
      // Use a smaller GPT-2 variant for speed
      const generator = await pipeline("text-generation", "Xenova/distilgpt2");

      loading.remove();
      input.disabled = false;
      sendBtn.disabled = false;

      function cavemanize(text) {
        return "Grak say: " + text
          .replace(/\bI am\b/gi, "me")
          .replace(/\bmy\b/gi, "Grakâ€™s")
          .replace(/\byou\b/gi, "u")
          .replace(/\bare\b/gi, "is")
          .replace(/\bthe\b/gi, "")
          .replace(/[.,!?]/g, "")
          .split(" ")
          .slice(0, 15) // limit length
          .join(" ") + " Ugh!";
      }

      async function send() {
        let userText = input.value.trim();
        if (!userText) return;
        input.value = "";

        chat.innerHTML += `<div class="msg user">You: ${userText}</div>`;
        chat.innerHTML += `<div class="msg grak" id="thinking">Grak thinking...</div>`;
        chat.scrollTop = chat.scrollHeight;

        // Generate based only on the last user input
        let output = await generator(userText, { max_new_tokens: 25, temperature: 0.9 });
        let rawReply = output[0].generated_text.replace(userText, "").trim();

        // Clean it into caveman speech
        let reply = cavemanize(rawReply);

        document.getElementById("thinking").remove();
        chat.innerHTML += `<div class="msg grak">${reply}</div>`;
        chat.scrollTop = chat.scrollHeight;
      }

      sendBtn.addEventListener("click", send);
      input.addEventListener("keypress", e => { if(e.key === "Enter") send(); });
    }

    initGrak();
  </script>
</body>
</html>
